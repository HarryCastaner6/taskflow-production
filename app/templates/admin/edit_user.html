{% extends "base.html" %}

{% block title %}Edit User - Admin - Task Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="bi bi-person-gear"></i> Edit User
            </h1>
            <div class="admin-nav">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-primary">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary">
                        <i class="bi bi-people"></i> Users
                    </a>
                    <a href="{{ url_for('admin.manage_boards') }}" class="btn btn-outline-primary">
                        <i class="bi bi-kanban"></i> Boards
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('admin.admin_dashboard') }}">Admin</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('admin.manage_users') }}">Users</a>
        </li>
        <li class="breadcrumb-item active">Edit User</li>
    </ol>
</nav>

<div class="row">
    <!-- User Info Card -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-circle text-primary"></i>
                    User Profile
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="avatar-lg mx-auto mb-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 80px; height: 80px; font-size: 2rem;">
                        {{ user.username[0].upper() }}
                    </div>
                </div>
                <h5 class="card-title">{{ user.username }}</h5>
                <p class="text-muted">{{ user.email }}</p>

                <div class="row text-center mt-3">
                    <div class="col-6">
                        <div class="border-end">
                            <h6 class="mb-1">{{ user.boards|length }}</h6>
                            <small class="text-muted">Boards</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="mb-1">{{ user.tasks|length }}</h6>
                        <small class="text-muted">Tasks</small>
                    </div>
                </div>

                <div class="mt-3">
                    {% if user.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    {% if user.is_admin %}
                        <span class="badge bg-danger">Administrator</span>
                    {% endif %}
                </div>

                <div class="mt-3 text-muted small">
                    <div><strong>Joined:</strong> {{ user.created_at.strftime('%B %d, %Y') }}</div>
                    {% if user.last_login %}
                    <div><strong>Last Login:</strong> {{ user.last_login.strftime('%B %d, %Y at %I:%M %p') }}</div>
                    {% else %}
                    <div><strong>Last Login:</strong> Never</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if user.is_active %}
                    <button type="button" class="btn btn-outline-warning btn-sm"
                            onclick="toggleUserStatus({{ user.id }}, false)">
                        <i class="bi bi-pause"></i> Deactivate User
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-outline-success btn-sm"
                            onclick="toggleUserStatus({{ user.id }}, true)">
                        <i class="bi bi-play"></i> Activate User
                    </button>
                    {% endif %}

                    <button type="button" class="btn btn-outline-info btn-sm" onclick="resetPassword()">
                        <i class="bi bi-key"></i> Reset Password
                    </button>

                    {% if user.id != current_user.id %}
                    <button type="button" class="btn btn-outline-danger btn-sm"
                            onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                        <i class="bi bi-trash"></i> Delete User
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pencil-square text-warning"></i>
                    Edit User Information
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="editUserForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information
                            </h6>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label">
                                Username <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control {{ 'is-invalid' if form.username.errors else '' }}"
                                   id="username" name="username" value="{{ form.username.data or user.username }}"
                                   placeholder="Enter username" required>
                            {% if form.username.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.username.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">
                                Email Address <span class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control {{ 'is-invalid' if form.email.errors else '' }}"
                                   id="email" name="email" value="{{ form.email.data or user.email }}"
                                   placeholder="Enter email address" required>
                            {% if form.email.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control {{ 'is-invalid' if form.first_name.errors else '' }}"
                                   id="first_name" name="first_name" value="{{ form.first_name.data or user.first_name or '' }}"
                                   placeholder="Enter first name">
                            {% if form.first_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.first_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control {{ 'is-invalid' if form.last_name.errors else '' }}"
                                   id="last_name" name="last_name" value="{{ form.last_name.data or user.last_name or '' }}"
                                   placeholder="Enter last name">
                            {% if form.last_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.last_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Password Change -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-shield-lock"></i> Password Change
                                <small class="text-muted">(Leave blank to keep current password)</small>
                            </h6>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="new_password" class="form-label">New Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control {{ 'is-invalid' if form.new_password.errors else '' }}"
                                       id="new_password" name="new_password" placeholder="Enter new password">
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('new_password')">
                                    <i class="bi bi-eye" id="new_password-eye"></i>
                                </button>
                            </div>
                            {% if form.new_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.new_password.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Minimum 8 characters, include letters and numbers</div>
                        </div>
                        <div class="col-md-6">
                            <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control {{ 'is-invalid' if form.confirm_new_password.errors else '' }}"
                                       id="confirm_new_password" name="confirm_new_password" placeholder="Confirm new password">
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirm_new_password')">
                                    <i class="bi bi-eye" id="confirm_new_password-eye"></i>
                                </button>
                            </div>
                            {% if form.confirm_new_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.confirm_new_password.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Account Settings -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-gear"></i> Account Settings
                            </h6>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                       {{ 'checked' if form.is_active.data if form.is_active.data is not none else user.is_active }}>
                                <label class="form-check-label" for="is_active">
                                    <strong>Active Account</strong>
                                </label>
                                <div class="form-text">Allow user to login and access the system</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if user.id != current_user.id %}
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_admin" name="is_admin"
                                       {{ 'checked' if form.is_admin.data if form.is_admin.data is not none else user.is_admin }}>
                                <label class="form-check-label" for="is_admin">
                                    <strong>Administrator Privileges</strong>
                                </label>
                                <div class="form-text">Grant full administrative access</div>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                You cannot modify your own administrator privileges.
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="email_verified" name="email_verified"
                                       {{ 'checked' if form.email_verified.data if form.email_verified.data is not none else user.email_verified }}>
                                <label class="form-check-label" for="email_verified">
                                    <strong>Email Verified</strong>
                                </label>
                                <div class="form-text">Mark email as verified</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="send_notification" name="send_notification" checked>
                                <label class="form-check-label" for="send_notification">
                                    <strong>Send Update Notification</strong>
                                </label>
                                <div class="form-text">Notify user about account changes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-chat-text"></i> Additional Information
                            </h6>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="notes" class="form-label">Admin Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"
                                      placeholder="Internal notes about this user (not visible to user)">{{ form.notes.data or user.notes or '' }}</textarea>
                            <div class="form-text">Internal notes for administrative purposes</div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <hr class="my-4">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Back to Users
                                </a>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                        <i class="bi bi-arrow-clockwise"></i> Reset Changes
                                    </button>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-check-lg"></i> Update User
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
                <p class="text-danger small">
                    <i class="bi bi-exclamation-triangle"></i>
                    This action cannot be undone. All user data will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteUserForm" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Delete User</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Generate a new password for <strong>{{ user.username }}</strong>?</p>
                <p class="text-info small">
                    <i class="bi bi-info-circle"></i>
                    A new temporary password will be generated and sent to the user's email address.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('admin.reset_user_password', user_id=user.id) }}" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-info">Reset Password</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const eyeIcon = document.getElementById(fieldId + '-eye');

    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeIcon.className = 'bi bi-eye-slash';
    } else {
        passwordField.type = 'password';
        eyeIcon.className = 'bi bi-eye';
    }
}

// Password confirmation validation
document.getElementById('confirm_new_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;

    if (confirmPassword && newPassword !== confirmPassword) {
        this.classList.add('is-invalid');
        this.setCustomValidity('Passwords do not match');
    } else {
        this.classList.remove('is-invalid');
        this.setCustomValidity('');
    }
});

// Delete user
function deleteUser(userId, username) {
    document.getElementById('deleteUserName').textContent = username;
    document.getElementById('deleteUserForm').action = "{{ url_for('admin.delete_user', user_id=0) }}".replace('0', userId);
    new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
}

// Reset password
function resetPassword() {
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

// Toggle user status
function toggleUserStatus(userId, activate) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('admin.toggle_user_status', user_id=0) }}".replace('0', userId);

    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    form.appendChild(csrfToken);

    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'is_active';
    statusInput.value = activate;
    form.appendChild(statusInput);

    document.body.appendChild(form);
    form.submit();
}

// Reset form
function resetForm() {
    if (confirm('Are you sure you want to reset all changes? Unsaved modifications will be lost.')) {
        location.reload();
    }
}

// Form submission with loading state
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating User...';

    // Re-enable button after 10 seconds as fallback
    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }, 10000);
});

// Admin privilege warning
{% if user.id != current_user.id %}
document.getElementById('is_admin').addEventListener('change', function() {
    if (this.checked) {
        if (!confirm('Are you sure you want to grant administrator privileges to this user? Administrators have full access to the system.')) {
            this.checked = false;
        }
    }
});
{% endif %}

// Warn about password change
document.getElementById('new_password').addEventListener('input', function() {
    if (this.value && !document.getElementById('send_notification').checked) {
        if (confirm('You are changing the password but notifications are disabled. Do you want to enable notifications so the user is informed of the password change?')) {
            document.getElementById('send_notification').checked = true;
        }
    }
});
</script>

<style>
.admin-nav .btn-group .btn {
    border-radius: 0;
}

.admin-nav .btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.admin-nav .btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.avatar-lg {
    margin: 0 auto;
}

.border-bottom {
    border-bottom: 2px solid #e9ecef !important;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.input-group .btn {
    border-left: 0;
}

.form-text {
    font-size: 0.875em;
    color: #6c757d;
}

.border-end {
    border-right: 1px solid #dee2e6 !important;
}

/* Loading state for form submission */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>
{% endblock %}