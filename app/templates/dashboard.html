{% extends "base.html" %}

{% block title %}Dashboard - Task Manager{% endblock %}

{% block content %}
<h1 class="mb-4">Dashboard</h1>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Total Tasks</h5>
                <p class="display-6">{{ stats.total }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Completed</h5>
                <p class="display-6 text-success">{{ stats.completed }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Pending</h5>
                <p class="display-6 text-warning">{{ stats.pending }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Overdue</h5>
                <p class="display-6 text-danger">{{ stats.overdue }}</p>
            </div>
        </div>
    </div>
</div>

{% if overdue_tasks %}
<div class="alert alert-danger" role="alert">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Overdue Tasks</h5>
    <ul class="mb-0">
        {% for task in overdue_tasks[:3] %}
        <li>
            <a href="{{ url_for('tasks.edit', task_id=task.id) }}" class="text-danger">
                {{ task.title }} - Due: {{ task.due_date.strftime('%Y-%m-%d') }}
            </a>
        </li>
        {% endfor %}
    </ul>
    {% if overdue_tasks|length > 3 %}
    <p class="mt-2 mb-0">
        <a href="{{ url_for('tasks.list_tasks', status='pending') }}" class="alert-link">
            View all overdue tasks â†’
        </a>
    </p>
    {% endif %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Pending Tasks</h5>
            </div>
            <div class="card-body">
                {% if tasks_by_status['pending'] %}
                <ul class="list-group list-group-flush">
                    {% for task in tasks_by_status['pending'][:5] %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('tasks.edit', task_id=task.id) }}">{{ task.title }}</a>
                            {% if task.priority == 'urgent' %}
                            <span class="badge bg-danger ms-1">Urgent</span>
                            {% elif task.priority == 'high' %}
                            <span class="badge bg-warning ms-1">High</span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No pending tasks</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">In Progress</h5>
            </div>
            <div class="card-body">
                {% if tasks_by_status['in_progress'] %}
                <ul class="list-group list-group-flush">
                    {% for task in tasks_by_status['in_progress'][:5] %}
                    <li class="list-group-item">
                        <a href="{{ url_for('tasks.edit', task_id=task.id) }}">{{ task.title }}</a>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No tasks in progress</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Recently Completed</h5>
            </div>
            <div class="card-body">
                {% if tasks_by_status['completed'] %}
                <ul class="list-group list-group-flush">
                    {% for task in tasks_by_status['completed'] %}
                    <li class="list-group-item">
                        <del class="text-muted">{{ task.title }}</del>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No completed tasks yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-pie-chart"></i> Task Status Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-bar-chart"></i> Task Priority Breakdown</h6>
            </div>
            <div class="card-body">
                <canvas id="priorityChart" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('tasks.create') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Create New Task
    </a>
    <a href="{{ url_for('tasks.list_tasks') }}" class="btn btn-outline-primary">
        <i class="bi bi-list"></i> View All Tasks
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// Task Status Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Completed', 'Pending', 'In Progress', 'Overdue'],
        datasets: [{
            data: [{{ stats.completed }}, {{ stats.pending }}, {{ tasks_by_status['in_progress']|length }}, {{ stats.overdue }}],
            backgroundColor: [
                '#198754', // green for completed
                '#ffc107', // yellow for pending
                '#0dcaf0', // cyan for in progress
                '#dc3545'  // red for overdue
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Priority Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
const priorityChart = new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: ['Low', 'Medium', 'High', 'Urgent'],
        datasets: [{
            label: 'Number of Tasks',
            data: [{{ priority_counts.low }}, {{ priority_counts.medium }}, {{ priority_counts.high }}, {{ priority_counts.urgent }}],
            backgroundColor: [
                '#6c757d', // gray for low
                '#0dcaf0', // cyan for medium
                '#fd7e14', // orange for high
                '#dc3545'  // red for urgent
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}